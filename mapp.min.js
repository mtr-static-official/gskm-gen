let isAdminMode=!1,apiKey=localStorage.getItem("addon-market-api-key")||"";function checkAdminStatus(){apiKey=localStorage.getItem("addon-market-api-key")||"",isAdminMode=!!apiKey,updateAdminUI()}function updateAdminUI(){var e=document.getElementById("adminToggle");e&&(e.innerHTML=isAdminMode?'<i class="fas fa-shield"></i> 管理员模式已启用':'<i class="fas fa-lock"></i> 开启管理员模式',e.classList.toggle("btn-outline-success",isAdminMode),e.classList.toggle("btn-outline-secondary",!isAdminMode))}let currentFilter="all",allAddonsCache=null;async function initApplication(){try{createFilterControls(),setupEventListeners(),await loadInitialData()}catch(e){handleFatalError(e)}}function createFilterControls(){document.querySelector(".container").insertAdjacentHTML("afterbegin",`
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="filter" id="filter-all" checked>
                <label class="btn btn-outline-primary" for="filter-all">全部</label>
                
                <input type="radio" class="btn-check" name="filter" id="filter-passed">
                <label class="btn btn-outline-primary" for="filter-passed">已审核</label>
                
                <input type="radio" class="btn-check" name="filter" id="filter-pending">
                <label class="btn btn-outline-primary" for="filter-pending">未审核</label>
            </div>
        </div>
    </div>
`)}function setupEventListeners(){document.querySelectorAll('input[name="filter"]').forEach(e=>{e.addEventListener("change",handleFilterChange)}),document.addEventListener("click",handleDownloadClick),document.getElementById("searchById").addEventListener("click",handleIdSearch),document.getElementById("adminToggle").addEventListener("click",()=>{isAdminMode?(apiKey="",localStorage.removeItem("addon-market-api-key"),isAdminMode=!1,updateAdminUI(),applyCurrentFilter(),showNotification("已退出管理员模式","info")):new bootstrap.Modal("#adminModal").show()}),document.getElementById("saveSecretKey").addEventListener("click",()=>{var e=document.getElementById("secretKeyInput").value.trim();e&&(apiKey=e,localStorage.setItem("addon-market-api-key",e),isAdminMode=!0,updateAdminUI(),bootstrap.Modal.getInstance("#adminModal").hide(),applyCurrentFilter(),showNotification("Secret Key已保存","success"))}),document.getElementById("manualRefresh").addEventListener("click",async()=>{showLoading();try{await loadInitialData()}catch(e){showError("手动刷新失败，请重试"),console.error("Manual refresh error:",e)}finally{hideLoading()}}),document.getElementById("submitAddon").addEventListener("click",async()=>{var e=document.getElementById("addonJsonInput").value.trim();if(e){try{JSON.parse(e)}catch(e){return void showNotification("无效的 JSON 格式","danger")}try{(await fetch("https://api.youmu.ltd/new/addon",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({string:e})})).ok?(showNotification("插件提交成功","success"),bootstrap.Modal.getInstance(document.getElementById("submitAddonModal")).hide(),await applyCurrentFilter()):showNotification("插件提交失败","danger")}catch(e){console.error("插件提交失败:",e),showNotification("插件提交失败，请重试","danger")}}else showNotification("请输入插件 JSON 内容","warning")})}async function loadInitialData(){showLoading();try{var[e]=await Promise.all([fetchAddons("all")]);allAddonsCache=e,applyCurrentFilter()}catch(e){throw showError("初始化加载失败，请刷新页面"),e}finally{hideLoading()}}async function handleFilterChange(e){currentFilter=e.target.id.split("-")[1],showLoading();try{await applyCurrentFilter()}catch(e){showError("筛选失败，请重试"),console.error("Filter error:",e)}finally{hideLoading()}}async function applyCurrentFilter(){let e;renderAddons(e="all"===currentFilter&&allAddonsCache?allAddonsCache:await fetchAddons(currentFilter))}async function fetchAddons(e){let t;switch(e){case"passed":t="/fetch/pass/1";break;case"pending":t="/fetch/pass/0";break;default:t="/fetch/all"}try{var a=await fetch(`https://api.youmu.ltd${t}?_=`+Date.now());if(a.ok)return await a.json();throw new Error("HTTP error! status: "+a.status)}catch(e){throw console.error("Fetch error:",e),new Error("无法获取插件数据")}}function renderAddons(e){document.getElementById("addons-list").innerHTML=e.map(e=>{var t=e.passed,a=isAdminMode?`
    <div class="mt-2">
        ${t?`<button class="btn btn-sm btn-danger reject-btn" data-id="${e.id}">
            <i class="fas fa-xmark"></i> 取消通过
        </button>`:`<button class="btn btn-sm btn-success approve-btn" data-id="${e.id}">
            <i class="fas fa-square-check"></i> 通过审核
        </button>`}
    </div>
    `:"";return`
    <div class="col">
        <div class="card addon-card h-100">
        <div class="card-body">
            <h5 class="card-title">${escapeHTML(e.name)}</h5>
            <span class="badge ${t?"bg-success":"bg-warning"}">
            ${t?"已审核":"待审核"}
            </span>
            <p class="card-text mt-2">${escapeHTML(e.description)}</p>
            <small class="text-muted">插件ID: ${e.id}</small>
            ${t||isAdminMode?`
            <div class="mt-3">
                <button class="btn btn-sm btn-primary download-btn" 
                data-content="${encodeURIComponent(e.content)}"
                data-filename="${encodeURIComponent(e.name)}">
                <i class="fas fa-download"></i>下载配置
                </button>
            </div>
            `:""}
            ${a}
            <div class="mt-3">
                <button class="btn btn-sm btn-info view-addon-btn" data-id="${e.id}">
                    <i class="fas fa-circle-info"></i>查看详情
                </button>
            </div>
        </div>
        </div>
    </div>
    `}).join(""),document.querySelectorAll(".approve-btn").forEach(e=>{e.addEventListener("click",()=>handleApprove(e.dataset.id))}),document.querySelectorAll(".reject-btn").forEach(e=>{e.addEventListener("click",()=>handleReject(e.dataset.id))}),document.querySelectorAll(".delete-btn").forEach(e=>{e.addEventListener("click",()=>handleDelete(e.dataset.id))}),document.querySelectorAll(".modify-btn").forEach(e=>{e.addEventListener("click",()=>handleModify(e.dataset.id))}),document.querySelectorAll(".view-addon-btn").forEach(n=>{n.addEventListener("click",async()=>{const t=parseInt(n.dataset.id);var e=allAddonsCache?.find(e=>e.id===t);if(e)showSingleAddon(e);else try{var a=await fetch("https://api.youmu.ltd/fetch/"+t);a.ok?showSingleAddon(await a.json()):showNotification("插件不存在或已删除","warning")}catch(e){showNotification("获取插件详情失败","danger")}})})}async function handleDownloadClick(e){e=e.target.closest(".download-btn");if(e)try{var t=decodeURIComponent(e.dataset.content),a=decodeURIComponent(e.dataset.filename),n=t.replace(/\\"/g,'"').replace(/\\n/g,"\n").replace(/\\t/g,"\t"),o=JSON.parse(n);downloadJSON(JSON.stringify(o,null,2),a)}catch(e){console.error("Download error:",e),alert("下载失败：配置文件格式异常")}}function downloadJSON(e,t){var e=new Blob([e],{type:"application/json"}),e=URL.createObjectURL(e),a=document.createElement("a");a.href=e,a.download=`${t}_${Date.now()}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(e)}function escapeHTML(e){return e.replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[e]||e)}function parseEscapedJSON(e){try{var t=e.replace(/\\"/g,'"').replace(/\\n/g,"\n").replace(/\\t/g,"\t").replace(/\\\\/g,"\\");return JSON.parse(t)}catch(e){return console.error("JSON解析失败:",e),{error:"Invalid JSON format"}}}function showLoading(){document.getElementById("loading").style.display="block"}function hideLoading(){document.getElementById("loading").style.display="none"}function showError(e){document.getElementById("addons-list").innerHTML=`
    <div class="col-12">
        <div class="alert alert-danger">${e}</div>
    </div>
`}function handleFatalError(e){document.body.innerHTML=`
    <div class="container mt-5">
        <div class="alert alert-danger">
            <h4>致命错误</h4>
            <p>${e.message}</p>
            <button class="btn btn-secondary" onclick="location.reload()">重新加载</button>
        </div>
    </div>
`}async function handleIdSearch(){var e=document.getElementById("searchId").value.trim();if(e){showLoading();try{var t=await fetch("https://api.youmu.ltd/fetch/"+e);if(404===t.status)throw new Error("未找到该插件");showSingleAddon(await t.json())}catch(e){showError("发生了错误！请检查输入的id是否存在。也可能是服务器发生故障。")}finally{hideLoading()}}else alert("请输入有效的插件ID")}function showSingleAddon(e){var t=e.passed,t=`
<div class="modal fade" id="addonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">${escapeHTML(e.name)}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>描述：</strong>${escapeHTML(e.description)}</p>
                        <p><strong>状态：</strong>
                            <span class="badge ${t?"bg-success":"bg-warning"}">
                                ${t?"已审核":"待审核"}
                            </span>
                        </p>
                        <p><strong>插件ID：</strong>${e.id}</p>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">配置信息</div>
                            <div class="card-body bg-light">
                                ${isAdminMode||t?`<pre>${escapeHTML(JSON.stringify(parseEscapedJSON(e.content),null,2))}</pre>`:`<div class="alert alert-warning m-0">
                                        <i class="fas fa-shield"></i>
                                        该插件尚未通过安全审核，无法查看配置详情
                                    </div>`}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                ${isAdminMode?`
                <div class="btn-group me-auto">
                    ${e.passed?`<button type="button" class="btn btn-danger reject-btn" data-id="${e.id}">
                            <i class="fas fa-ban"></i> 取消审核
                        </button>`:`<button type="button" class="btn btn-success approve-btn" data-id="${e.id}">
                            <i class="fas fa-circle-check"></i> 通过审核
                        </button>`}
                </div>
                `:""}
                
                ${isAdminMode||t?`
                <button class="btn btn-primary download-btn" 
                    data-content="${encodeURIComponent(e.content)}"
                    data-filename="${encodeURIComponent(e.name)}">
                    <i class="fas fa-download"></i> 下载
                </button>
                `:""}
                
                ${isAdminMode?`
                <button type="button" class="btn btn-danger delete-btn" data-id="${e.id}">
                    <i class="fas fa-trash"></i> 删除
                </button>
                <button type="button" class="btn btn-warning modify-btn" data-id="${e.id}">
                    <i class="fas fa-pencil-square"></i> 修改
                </button>
                `:""}
                
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-xmark"></i>关闭</button>
            </div>
        </div>
    </div>
</div>`;document.body.insertAdjacentHTML("beforeend",t);const a=document.getElementById("addonModal"),n=new bootstrap.Modal(a);n.show(),a.addEventListener("hidden.bs.modal",()=>{n.dispose(),a.remove()}),a.querySelector(".download-btn")?.addEventListener("click",handleDownloadClick),a.querySelector(".delete-btn")?.addEventListener("click",()=>handleDelete(e.id)),a.querySelector(".modify-btn")?.addEventListener("click",()=>handleModify(e.id)),a.querySelector(".approve-btn")?.addEventListener("click",()=>handleApprove(e.id)),a.querySelector(".reject-btn")?.addEventListener("click",()=>handleReject(e.id))}async function handleApprove(e){try{var t=await(await fetch("https://api.youmu.ltd/pass/"+e,{method:"GET",headers:{"Content-Type":"application/json","X-API-Key":apiKey}})).json();0===t.id?(showNotification("审核通过成功","success"),await applyCurrentFilter()):100===t.id?showNotification("鉴权失败，请检查API Key","warning"):201===t.id?showNotification("未找到相应Addon","warning"):showNotification("未知错误","danger")}catch(e){console.error("审核通过失败:",e),showNotification("审核通过失败，请重试","danger")}}async function handleReject(e){try{var t=await(await fetch("https://api.youmu.ltd/reject/"+e,{method:"GET",headers:{"Content-Type":"application/json","X-API-Key":apiKey}})).json();0===t.id?(showNotification("取消审核通过成功","success"),await applyCurrentFilter()):100===t.id?showNotification("鉴权失败，请检查API Key","warning"):201===t.id?showNotification("未找到相应Addon","warning"):showNotification("未知错误","danger")}catch(e){console.error("取消审核通过失败:",e),showNotification("取消审核通过失败，请重试","danger")}}async function handleDelete(e){if(confirm("确定要删除这个插件吗？此操作无法撤销。"))try{var t=await(await fetch("https://api.youmu.ltd/delete/"+e,{method:"GET",headers:{"Content-Type":"application/json","X-API-Key":apiKey}})).json();0===t.id?(showNotification("插件删除成功","success"),await applyCurrentFilter()):100===t.id?showNotification("鉴权失败，请检查API Key","warning"):201===t.id?showNotification("未找到相应Addon","warning"):showNotification("未知错误","danger")}catch(e){console.error("插件删除失败:",e),showNotification("插件删除失败，请重试","danger")}}async function handleModify(e){var t=prompt("请输入新的插件 JSON 内容:");if(t){try{JSON.parse(t)}catch(e){return void showNotification("无效的 JSON 格式","danger")}try{(await fetch("https://api.youmu.ltd/modify/"+e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-API-Key":apiKey},body:new URLSearchParams({string:t})})).ok?(showNotification("插件修改成功","success"),await applyCurrentFilter()):showNotification("插件修改失败","danger")}catch(e){console.error("插件修改失败:",e),showNotification("插件修改失败，请重试","danger")}}else showNotification("插件 JSON 内容不能为空","warning")}function showNotification(e,t="info"){var a=document.getElementById("notificationToast");a.querySelector(".toast-body").textContent=e,a.classList.remove("bg-info","bg-success","bg-danger","bg-warning"),a.classList.add("bg-"+t),new bootstrap.Toast(a).show()}window.addEventListener("DOMContentLoaded",()=>{checkAdminStatus(),initApplication()});