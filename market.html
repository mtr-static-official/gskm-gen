<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>插件市场</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <!-- Bootstrap 5 -->
    <link href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #ffcccc;
            font-family: 'Arial', sans-serif;
        }
        .navbar {
            background-color: #ff4d4d;
        }
        .navbar .btn-outline-secondary {
            color: #fff;
            border-color: #fff;
        }
        .navbar .btn-outline-secondary:hover {
            background-color: #fff;
            color: #ff4d4d;
        }
        .addon-card {
            margin: 1rem 0;
            transition: transform 0.2s;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ff4d4d;
        }
        .addon-card:hover {
            transform: translateY(-3px);
        }
        .btn-primary {
            background: linear-gradient(45deg, #ff4d4d, #ff8080);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, #ff8080, #ff4d4d);
        }
        .btn-secondary {
            background: linear-gradient(45deg, #4d4dff, #8080ff);
            border: none;
        }
        .btn-secondary:hover {
            background: linear-gradient(45deg, #8080ff, #4d4dff);
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.9);
        }
        .badge {
            font-size: 1rem;
        }
        .text-gradient {
            background: linear-gradient(45deg, #ff4d4d, #ff8080);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .navbar .btn-outline-success {
            color: #fff;
            background-color: #28a745;
            border-color: #28a745;
        }
        .navbar .btn-outline-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        @media (max-width: 768px) {
        /* 导航栏按钮垂直排列 */
        .navbar .btn-group {
            width: 100%;
            flex-direction: column;
        }

        .navbar .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        /* 操作按钮区域 */
        .text-end {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* 搜索框调整 */
        #searchId {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        #searchById {
            width: 100%;
        }

        /* 卡片间距优化 */
        .addon-card {
            margin: 0.5rem 0;
            border-radius: 0.75rem;
        }

        /* 模态框全屏 */
        .modal-dialog {
            margin: 1.75rem auto; /* 恢复默认外边距 */
            max-width: 96%; /* 添加最大宽度限制 */
        }

        .modal-content {
            border-radius: 0.5rem; /* 恢复圆角 */
        }


        /* 按钮组垂直排列 */
        .btn-group > .btn {
            width: 100%;
            margin: 0.25rem 0;
        }

        /* 输入组垂直排列 */
        .input-group {
            flex-direction: column;
        }

        .input-group > .form-control,
        .input-group > .btn {
            width: 100%;
            margin: 0.25rem 0;
        }

        /* 卡片内容优化 */
        .card-title {
            font-size: 1.25rem;
        }

        .card-text {
            font-size: 0.9rem;
        }

        /* 底部footer调整 */
        footer p {
            font-size: 0.85rem;
            line-height: 1.4;
        }
    }

    /* 小屏手机特殊适配 */
    @media (max-width: 480px) {
        h1 {
            font-size: 1.75rem;
        }

        .badge {
            font-size: 0.8rem;
        }

        .modal-body pre {
            font-size: 0.7rem;
            overflow-x: auto;
        }

        footer {
            font-size: 0.8rem;
        }
    }

    /* 平板设备适配 */
    @media (min-width: 769px) and (max-width: 1024px) {
        .addon-card {
            margin: 0.75rem;
        }
        
        .row-cols-md-2 .col {
            flex: 0 0 50%;
            max-width: 50%;
        }
    }
    @media (max-width: 767.98px) {
    .mobile-input-group {
        flex-direction: column;
        gap: 12px;
    }

    .search-input {
        width: 100% !important;
        border-radius: 8px !important;
        padding: 12px 16px;
        font-size: 16px; /* 优化移动端输入字号 */
    }

    .search-btn {
        width: 100%;
        border-radius: 8px !important;
        padding: 14px;
        font-size: 16px;
        order: 2; /* 确保按钮在输入框下方 */
    }

    /* 修复iOS输入框缩放问题 */
    @supports (-webkit-overflow-scrolling: touch) {
        input[type="number"] {
            font-size: 16px;
            transform: scale(0.98);
        }
    }
}
@media (max-width: 767.98px) {
    /* 模态框自适应调整 */
    .modal-dialog {
        width: auto;
        margin: 10px;
    }
    
    .modal-content {
        min-height: auto; /* 移除强制高度 */
    }
    
    /* 输入框优化 */
    .search-input {
        width: 100% !important;
        max-width: 100%;
        padding: 12px;
    }
    
    /* 按钮优化 */
    .search-btn {
        width: auto;
        min-width: 100px;
        padding: 12px 20px;
    }
}

/* 内容自适应模态框 */
.auto-size-modal .modal-dialog {
    width: auto;
    max-width: 600px; /* 设置最大限制 */
    margin: 20px auto;
}

/* 表单元素优化 */
.modal-body textarea {
    min-height: 200px; /* 合理的最小高度 */
    max-height: 70vh; /* 设置最大高度 */
    overflow-y: auto;
    resize: vertical; /* 允许垂直调整 */
}

/* 页脚按钮优化 */
.modal-footer {
    flex-wrap: nowrap; /* 防止按钮换行 */
    gap: 10px;
}

/* 输入框组优化 */
.input-group {
    max-width: 500px; /* 限制最大宽度 */
    margin: 0 auto;
}
</style>
<style>
    /* 页脚优化样式 */
    .market-footer {
        background: rgba(255, 255, 255, 0.95);
        border-top: 2px solid #ff4d4d;
        box-shadow: 0 -4px 12px rgba(255, 77, 77, 0.1);
        margin-top: 3rem;
        padding: 2rem 0;
    }
    
    .disclaimer-box {
        background: #fff5f5;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 2rem;
        border: 1px solid #ffcccc;
        position: relative;
    }
    
    .disclaimer-box i {
        position: absolute;
        left: 1rem;
        top: -0.8rem;
        font-size: 1.5rem;
        background: white;
        padding: 0 0.25rem;
    }
    
    .disclaimer-text {
        color: #cc3333;
        font-size: 0.9rem;
        line-height: 1.6;
        margin: 0;
        text-align: center;
    }
    
    .credit-box {
        display: grid;
        gap: 1.5rem;
        text-align: center;
    }
    
    .credit-item {
        padding: 0.75rem 0;
        border-bottom: 1px dashed #eee;
    }
    
    .credit-item:last-child {
        border-bottom: none;
    }
    
    .credit-label {
        color: #ff4d4d;
        font-weight: 500;
        margin-right: 0.5rem;
    }
    
    .credit-item a {
        color: #666;
        text-decoration: none;
        transition: color 0.3s;
    }
    
    .credit-item a:hover {
        color: #ff4d4d;
    }
    
    .badge {
        font-weight: normal;
        margin: 0 3px;
        vertical-align: baseline;
    }
    
    .bg-vercel {
        background: linear-gradient(45deg, #000, #444);
    }
    
    .bg-bootstrap {
        background: linear-gradient(45deg, #7952b3, #563d7c);
    }
    
    @media (max-width: 767.98px) {
        .market-footer {
            padding: 1.5rem 0;
        }
        
        .disclaimer-text {
            font-size: 0.8rem;
            text-align: left;
            padding-left: 1.5rem;
        }
        
        .credit-box {
            gap: 1rem;
        }
        
        .credit-item {
            font-size: 0.9rem;
        }
    }
    </style>
    <style>
/* 修改现有toast样式 */
.toast-container {
    z-index: 99999 !important; /* 确保最高层级 */
    position: fixed;
    top: 20px;
    right: 20px;
}

/* 强制提升toast层级 */
.toast {
    position: relative;
    z-index: 999999 !important; /* 双重保险 */
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

/* 移动端适配 */
@media (max-width: 767.98px) {
    .toast-container {
        top: 10px;
        right: 10px;
        left: 10px;
        width: auto;
    }
    
    .toast {
        width: 100% !important;
        max-width: 100%;
    }
}
</style>
       <link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container-fluid">
          <button class="btn btn-sm btn-outline-secondary ms-auto" id="adminToggle">
            <i class="bi bi-shield-lock"></i> 开启管理员模式
          </button>
        </div>
    </nav>
    <div class="modal fade" id="adminModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">管理员认证</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Secret Key</label>
                <input type="password" class="form-control" id="secretKeyInput">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="saveSecretKey">保存</button>
            </div>
          </div>
        </div>
    </div>
    <div class="modal fade" id="submitAddonModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">提交新插件</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">插件 JSON 内容</label>
                        <textarea class="form-control" id="addonJsonInput" rows="10"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitAddon">提交</button>
                </div>
            </div>
        </div>
    </div>
    <div class="container py-4">
        <h1 class="mb-4 text-center text-gradient">插件市场</h1>
        
        <!-- 修改筛选和操作按钮布局部分：优化filter按钮、手动刷新和提交新插件按钮布局 -->
        <!-- 替换原有的筛选和操作按钮代码 -->
        <div class="row mb-4">
            <div class="col-md-8">
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-secondary me-2" id="manualRefresh">
                    <i class="bi bi-arrow-clockwise"></i> 手动刷新
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#submitAddonModal">
                    <i class="bi bi-plus-circle"></i> 提交新插件
                </button>
            </div>
        </div>

        <!-- 加载状态 -->

        <div class="row mb-3">
            <div class="col-12">
                <div class="input-group mobile-input-group">
                    <input type="number" id="searchId" 
                           class="form-control search-input"
                           placeholder="输入插件ID"
                           min="1">
                    <button class="btn btn-primary search-btn" id="searchById">
                        <i class="bi bi-search"></i> 搜索
                    </button>
                </div>
            </div>
        </div>
        
        <div id="loading" class="text-center">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">正在加载插件...</p>
        </div>
        <!-- 插件列表 -->
        <div id="addons-list" class="row row-cols-1 row-cols-md-2 g-4"></div>
    </div>

    <!-- 添加通知容器 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        let isAdminMode = false;
        let apiKey = localStorage.getItem('addon-market-api-key') || '';

        // 初始化时检查密钥
        function checkAdminStatus() {
            apiKey = localStorage.getItem('addon-market-api-key') || '';
            isAdminMode = !!apiKey;
            updateAdminUI();
        }

        // 更新管理员UI状态
        function updateAdminUI() {
            const adminBtn = document.getElementById('adminToggle');
            if (!adminBtn) return;

            adminBtn.innerHTML = isAdminMode ? 
                `<i class="bi bi-shield-check"></i> 管理员模式已启用` :
                `<i class="bi bi-shield-lock"></i> 开启管理员模式`;

            adminBtn.classList.toggle('btn-outline-success', isAdminMode);
            adminBtn.classList.toggle('btn-outline-secondary', !isAdminMode);
        }
        // 全局状态管理
        let currentFilter = 'all'; // all | passed | pending
        let allAddonsCache = null;
    
        // 初始化入口
        window.addEventListener('DOMContentLoaded', () => {
            checkAdminStatus();
            initApplication();
        });
    
        async function initApplication() {
            try {
                createFilterControls();
                setupEventListeners();
                await loadInitialData();
            } catch (error) {
                handleFatalError(error);
            }
        }
    
        // 创建筛选控件
        function createFilterControls() {
            const container = document.querySelector('.container');
            container.insertAdjacentHTML('afterbegin', `
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="filter" id="filter-all" checked>
                            <label class="btn btn-outline-primary" for="filter-all">全部</label>
                            
                            <input type="radio" class="btn-check" name="filter" id="filter-passed">
                            <label class="btn btn-outline-primary" for="filter-passed">已审核</label>
                            
                            <input type="radio" class="btn-check" name="filter" id="filter-pending">
                            <label class="btn btn-outline-primary" for="filter-pending">未审核</label>
                        </div>
                    </div>
                </div>
            `);
        }
    
        // 事件监听设置
        function setupEventListeners() {
            // 筛选切换
            document.querySelectorAll('input[name="filter"]').forEach(radio => {
                radio.addEventListener('change', handleFilterChange);
            });
    
            // 下载按钮委托
            document.addEventListener('click', handleDownloadClick);
            document.getElementById('searchById').addEventListener('click', handleIdSearch);
            document.getElementById('adminToggle').addEventListener('click', () => {
            if (!isAdminMode) {
                new bootstrap.Modal('#adminModal').show();
            } else {
                // 退出管理员模式
                apiKey = '';
                localStorage.removeItem('addon-market-api-key');
                isAdminMode = false;
                updateAdminUI();
                applyCurrentFilter(); // 刷新列表
                showNotification('已退出管理员模式', 'info');
            }
            });
            document.getElementById('saveSecretKey').addEventListener('click', () => {
            const key = document.getElementById('secretKeyInput').value.trim();
            if (key) {
                apiKey = key;
                localStorage.setItem('addon-market-api-key', key);
                isAdminMode = true;
                updateAdminUI();
                bootstrap.Modal.getInstance('#adminModal').hide();
                applyCurrentFilter(); // 刷新列表
                showNotification('Secret Key已保存', 'success');
            }
            });

            // 手动刷新按钮
            document.getElementById('manualRefresh').addEventListener('click', async () => {
                showLoading();
                try {
                    await loadInitialData();
                } catch (error) {
                    showError('手动刷新失败，请重试');
                    console.error('Manual refresh error:', error);
                } finally {
                    hideLoading();
                }
            });

            // 提交新插件处理
            document.getElementById('submitAddon').addEventListener('click', async () => {
                const addonJsonInput = document.getElementById('addonJsonInput').value.trim();
                if (!addonJsonInput) {
                    showNotification('请输入插件 JSON 内容', 'warning');
                    return;
                }

                try {
                    JSON.parse(addonJsonInput); // 验证 JSON 格式
                } catch (error) {
                    showNotification('无效的 JSON 格式', 'danger');
                    return;
                }

                try {
                    const response = await fetch('https://api.youmu.ltd/new/addon', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({ string: addonJsonInput })
                    });

                    if (response.ok) {
                        showNotification('插件提交成功', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('submitAddonModal')).hide();
                        await applyCurrentFilter(); // 刷新列表
                    } else {
                        showNotification('插件提交失败', 'danger');
                    }
                } catch (error) {
                    console.error('插件提交失败:', error);
                    showNotification('插件提交失败，请重试', 'danger');
                }
            });
        }
    
        // 初始数据加载
        async function loadInitialData() {
            showLoading();
            try {
                const [allData] = await Promise.all([
                    fetchAddons('all'),
                    // 可在此添加其他预加载请求
                ]);
                allAddonsCache = allData;
                applyCurrentFilter();
            } catch (error) {
                showError('初始化加载失败，请刷新页面');
                throw error;
            } finally {
                hideLoading();
            }
        }
    
        // 筛选处理
        async function handleFilterChange(e) {
            currentFilter = e.target.id.split('-')[1];
            showLoading();
            try {
                await applyCurrentFilter();
            } catch (error) {
                showError('筛选失败，请重试');
                console.error('Filter error:', error);
            } finally {
                hideLoading();
            }
        }
    
        // 应用当前筛选
        async function applyCurrentFilter() {
            let data;
            if (currentFilter === 'all' && allAddonsCache) {
                data = allAddonsCache;
            } else {
                data = await fetchAddons(currentFilter);
            }
            renderAddons(data);
        }
    
        // 数据获取
        async function fetchAddons(filterType) {
            let endpoint;
            switch(filterType) {
                case 'passed':
                    endpoint = '/fetch/pass/1';
                    break;
                case 'pending':
                    endpoint = '/fetch/pass/0';
                    break;
                default:
                    endpoint = '/fetch/all';
            }
    
            try {
                const response = await fetch(`https://api.youmu.ltd${endpoint}?_=${Date.now()}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                throw new Error('无法获取插件数据');
            }
        }
    
        // 渲染插件列表
        function renderAddons(addons) {
        const listContainer = document.getElementById('addons-list');
        listContainer.innerHTML = addons.map(addon => {
            const isPassed = addon.passed;
            const adminControls = isAdminMode ? `
            <div class="mt-2">
                ${isPassed ? 
                `<button class="btn btn-sm btn-danger reject-btn" data-id="${addon.id}">
                    <i class="bi bi-x-circle"></i> 取消通过
                </button>` : 
                `<button class="btn btn-sm btn-success approve-btn" data-id="${addon.id}">
                    <i class="bi bi-check-circle"></i> 通过审核
                </button>`
                }
            </div>
            ` : '';

            return `
            <div class="col">
                <div class="card addon-card h-100">
                <div class="card-body">
                    <h5 class="card-title">${escapeHTML(addon.name)}</h5>
                    <span class="badge ${isPassed ? 'bg-success' : 'bg-warning'}">
                    ${isPassed ? '已审核' : '待审核'}
                    </span>
                    <p class="card-text mt-2">${escapeHTML(addon.description)}</p>
                    <small class="text-muted">插件ID: ${addon.id}</small>
                    ${isPassed ? `
                    <div class="mt-3">
                        <button class="btn btn-sm btn-primary download-btn" 
                        data-content="${encodeURIComponent(addon.content)}"
                        data-filename="${encodeURIComponent(addon.name)}">
                        下载配置
                        </button>
                    </div>
                    ` : ''}
                    ${adminControls}
                </div>
                </div>
            </div>
            `;
        }).join('');

        // 绑定新按钮事件
        document.querySelectorAll('.approve-btn').forEach(btn => {
            btn.addEventListener('click', () => handleApprove(btn.dataset.id));
        });
        document.querySelectorAll('.reject-btn').forEach(btn => {
            btn.addEventListener('click', () => handleReject(btn.dataset.id));
        });
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => handleDelete(btn.dataset.id));
        });
        document.querySelectorAll('.modify-btn').forEach(btn => {
            btn.addEventListener('click', () => handleModify(btn.dataset.id));
        });
        }
    
        // 下载处理
        async function handleDownloadClick(e) {
            const btn = e.target.closest('.download-btn');
            if (!btn) return;
    
            try {
                const rawContent = decodeURIComponent(btn.dataset.content);
                const fileName = decodeURIComponent(btn.dataset.filename);
                
                const content = rawContent
                    .replace(/\\"/g, '"')
                    .replace(/\\n/g, '\n')
                    .replace(/\\t/g, '\t');
    
                const parsed = JSON.parse(content);
                downloadJSON(JSON.stringify(parsed, null, 2), fileName);
            } catch (error) {
                console.error('Download error:', error);
                alert('下载失败：配置文件格式异常');
            }
        }
    
        // 工具函数
        function downloadJSON(content, fileName) {
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, 
                tag => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[tag] || tag));
        }
        
        function parseEscapedJSON(str) {
            try {
                const cleaned = str
                    .replace(/\\"/g, '"')   // 替换转义双引号
                    .replace(/\\n/g, '\n')  // 替换换行符
                    .replace(/\\t/g, '\t')  // 替换制表符
                    .replace(/\\\\/g, '\\');// 替换转义反斜杠
                
                return JSON.parse(cleaned);
            } catch (e) {
                console.error('JSON解析失败:', e);
                return { error: "Invalid JSON format" };
            }
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }
    
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
    
        function showError(message) {
            const container = document.getElementById('addons-list');
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">${message}</div>
                </div>
            `;
        }
    
        function handleFatalError(error) {
            document.body.innerHTML = `
                <div class="container mt-5">
                    <div class="alert alert-danger">
                        <h4>致命错误</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-secondary" onclick="location.reload()">重新加载</button>
                    </div>
                </div>
            `;
        }
        async function handleIdSearch() {
    const idInput = document.getElementById('searchId');
    const id = idInput.value.trim();
    
    if (!id) {
        alert('请输入有效的插件ID');
        return;
    }

    showLoading();
    try {
        const response = await fetch(`https://api.youmu.ltd/fetch/${id}`);
        if (response.status === 404) {
            throw new Error('未找到该插件');
        }
        const addon = await response.json();
        showSingleAddon(addon);
    } catch (error) {
        showError("发生了错误！请检查输入的id是否存在。也可能是服务器发生故障。");
    } finally {
        hideLoading();
    }
}

// 新增显示单个插件的模态框
    function showSingleAddon(addon) {
        const isPassed = addon.passed;
        
        // 创建模态框HTML
        const modalHtml = `
        <div class="modal fade" id="addonModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${escapeHTML(addon.name)}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>描述：</strong>${escapeHTML(addon.description)}</p>
                                <p><strong>状态：</strong>
                                    <span class="badge ${isPassed ? 'bg-success' : 'bg-warning'}">
                                        ${isPassed ? '已审核' : '待审核'}
                                    </span>
                                </p>
                                <p><strong>插件ID：</strong>${addon.id}</p>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">配置信息</div>
                                    <div class="card-body bg-light">
                                        ${isPassed ? 
                                            `<pre>${escapeHTML(JSON.stringify(parseEscapedJSON(addon.content), null, 2))}</pre>` :
                                            `<div class="alert alert-warning m-0">
                                                <i class="bi bi-shield-lock"></i>
                                                该插件尚未通过安全审核，无法查看配置详情
                                            </div>`
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        ${isPassed ? `
                        <button class="btn btn-primary download-btn" 
                            data-content="${encodeURIComponent(addon.content)}"
                            data-filename="${encodeURIComponent(addon.name)}">
                            <i class="bi bi-download"></i> 下载配置
                        </button>
                        ` : ''}
                        <button type="button" class="btn btn-danger delete-btn" data-id="${addon.id}">
                            <i class="bi bi-trash"></i> 删除插件
                        </button>
                        ${isAdminMode ? `
                        <button type="button" class="btn btn-warning modify-btn" data-id="${addon.id}">
                            <i class="bi bi-pencil-square"></i> 修改插件
                        </button>
                        ` : ''}
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>`;

        // 插入到DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // 初始化并显示模态框
        const modalElement = document.getElementById('addonModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();

        // 清理逻辑
        modalElement.addEventListener('hidden.bs.modal', () => {
            modal.dispose();
            modalElement.remove();
        });

        // 绑定下载事件（复用之前的处理逻辑）
        modalElement.querySelector('.download-btn')?.addEventListener('click', handleDownloadClick);
        modalElement.querySelector('.delete-btn')?.addEventListener('click', () => handleDelete(addon.id));
        modalElement.querySelector('.modify-btn')?.addEventListener('click', () => handleModify(addon.id));
    }

    // 审核通过处理
    async function handleApprove(id) {
        try {
            const response = await fetch(`https://api.youmu.ltd/pass/${id}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey
                }
            });
            const result = await response.json();
            if (result.id === 0) {
                showNotification('审核通过成功', 'success');
                await applyCurrentFilter(); // 刷新列表
            } else if (result.id === 100) {
                showNotification('鉴权失败，请检查API Key', 'warning');
            } else if (result.id === 201) {
                showNotification('未找到相应Addon', 'warning');
            } else {
                showNotification('未知错误', 'danger');
            }
        } catch (error) {
            console.error('审核通过失败:', error);
            showNotification('审核通过失败，请重试', 'danger');
        }
    }

    // 取消审核通过处理
    async function handleReject(id) {
        try {
            const response = await fetch(`https://api.youmu.ltd/reject/${id}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey
                }
            });
            const result = await response.json();
            if (result.id === 0) {
                showNotification('取消审核通过成功', 'success');
                await applyCurrentFilter(); // 刷新列表
            } else if (result.id === 100) {
                showNotification('鉴权失败，请检查API Key', 'warning');
            } else if (result.id === 201) {
                showNotification('未找到相应Addon', 'warning');
            } else {
                showNotification('未知错误', 'danger');
            }
        } catch (error) {
            console.error('取消审核通过失败:', error);
            showNotification('取消审核通过失败，请重试', 'danger');
        }
    }

    // 删除插件处理
    async function handleDelete(id) {
        if (!confirm('确定要删除这个插件吗？此操作无法撤销。')) {
            return;
        }

        try {
            const response = await fetch(`https://api.youmu.ltd/delete/${id}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey
                }
            });
            const result = await response.json();
            if (result.id === 0) {
                showNotification('插件删除成功', 'success');
                await applyCurrentFilter(); // 刷新列表
            } else if (result.id === 100) {
                showNotification('鉴权失败，请检查API Key', 'warning');
            } else if (result.id === 201) {
                showNotification('未找到相应Addon', 'warning');
            } else {
                showNotification('未知错误', 'danger');
            }
        } catch (error) {
            console.error('插件删除失败:', error);
            showNotification('插件删除失败，请重试', 'danger');
        }
    }

    // 修改插件处理
    async function handleModify(id) {
        const newContent = prompt('请输入新的插件 JSON 内容:');
        if (!newContent) {
            showNotification('插件 JSON 内容不能为空', 'warning');
            return;
        }

        try {
            JSON.parse(newContent); // 验证 JSON 格式
        } catch (error) {
            showNotification('无效的 JSON 格式', 'danger');
            return;
        }

        try {
            const response = await fetch(`https://api.youmu.ltd/modify/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-API-Key': apiKey
                },
                body: new URLSearchParams({ string: newContent })
            });

            if (response.ok) {
                showNotification('插件修改成功', 'success');
                await applyCurrentFilter(); // 刷新列表
            } else {
                showNotification('插件修改失败', 'danger');
            }
        } catch (error) {
            console.error('插件修改失败:', error);
            showNotification('插件修改失败，请重试', 'danger');
        }
    }

    // 显示通知
    function showNotification(message, type = 'info') {
        const toastEl = document.getElementById('notificationToast');
        const toastBody = toastEl.querySelector('.toast-body');
        toastBody.textContent = message;

        toastEl.classList.remove('bg-info', 'bg-success', 'bg-danger', 'bg-warning');
        toastEl.classList.add(`bg-${type}`);

        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
    </script>
<!-- 添加Footer -->
<footer class="market-footer">
    <div class="container">
        <div class="footer-content">
            <div class="disclaimer-box">
                <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                <p class="disclaimer-text">
                    Addon的标题与描述由用户提交，与本站立场无关。

                    请勿过度解读或用于非游戏场景。
                </p>
            </div>
            
            <div class="credit-box">
                <div class="credit-item">
                    <span class="credit-label">开发者：</span>
                    <a href="https://youmu.ltd" target="_blank">MTR</a>
                </div>
                <div class="credit-item">
                    <span class="credit-label">灵感来源：</span>
                    <a href="https://gskmail.thmobile.xyz/" target="_blank">☯ Gensokyo Mail</a>
                </div>
                <div class="credit-item">
                    <span class="credit-label">技术支持：</span>
                    <span class="tech-stack">
                        <span class="badge bg-vercel">Vercel</span>
                        <span class="badge bg-bootstrap">Bootstrap 5</span>
                    </span>
                </div>
            </div>
        </div>
    </div>
</footer>
    </body>
</html>